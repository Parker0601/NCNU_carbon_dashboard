{{#> 
    layouts/main 
    title="廢料處理記錄" 
    pagename="waste_management"
    heading="廢料處理記錄"
    category_1="員工專區"
    pagedescription="記錄廢料處理情況，用於碳匯計算"
}}

{{#*inline "head-block"}}
<link rel="stylesheet" media="screen, print" href="css/statistics/c3/c3.css">
{{/inline}}

{{#*inline "content-block"}}
<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title">新增廢料處理記錄</h5>
            </div>
            <div class="card-body">
                <form id="waste-form">
                    <div class="form-group">
                        <label for="waste-type">廢料類型</label>
                        <select class="form-control" id="waste-type" required>
                            <option value="">請選擇廢料類型</option>
                            <option value="廚餘">廚餘</option>
                            <option value="農業廢料">農業廢料</option>
                            <option value="園藝廢料">園藝廢料</option>
                            <option value="其他有機廢料">其他有機廢料</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="waste-weight">廢料重量 (kg)</label>
                        <input type="number" class="form-control" id="waste-weight" min="0" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="process-date">處理日期</label>
                        <input type="date" class="form-control" id="process-date" required>
                    </div>
                    <button type="submit" class="btn btn-primary">提交記錄</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">本週廢料處理趨勢</h5>
            </div>
            <div class="card-body">
                <div id="waste-trend-chart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>
{{/inline}}

{{#*inline "scripts-block"}}
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.js"></script>
<script>
    // 初始化圖表
    let wasteChart = c3.generate({
        bindto: '#waste-trend-chart',
        data: {
            x: 'x',
            columns: [
                ['x'],
                ['廢料量(kg)']
            ],
            type: 'line'
        },
        axis: {
            x: {
                type: 'timeseries',
                tick: {
                    format: '%m-%d'
                }
            },
            y: {
                label: {
                    text: '重量 (kg)',
                    position: 'outer-middle'
                }
            }
        },
        grid: {
            y: {
                show: true
            }
        }
    });

    // 獲取本週廢料處理數據
    function fetchWeeklyWasteData() {
        // TODO: 換成實際API
        return Promise.resolve([
            { date: '2024-06-10', weight: 15.5, type: '廚餘' },
            { date: '2024-06-11', weight: 12.3, type: '農業廢料' },
            { date: '2024-06-12', weight: 18.7, type: '園藝廢料' }
        ]);
    }

    // 更新圖表
    function updateChart(data) {
        const dates = ['x'];
        const weights = ['廢料量(kg)'];
        
        data.forEach(item => {
            dates.push(item.date);
            weights.push(item.weight);
        });

        wasteChart.load({
            columns: [dates, weights]
        });
    }

    // 提交表單
    $('#waste-form').on('submit', function(e) {
        e.preventDefault();
        
        const wasteData = {
            type: $('#waste-type').val(),
            weight: parseFloat($('#waste-weight').val()),
            date: $('#process-date').val()
        };

        // TODO: 換成實際API
        console.log('提交廢料數據:', wasteData);
        
        Swal.fire({
            title: '提交成功',
            text: '廢料處理記錄已保存',
            icon: 'success',
            confirmButtonText: '確定'
        }).then(() => {
            // 重置表單
            $('#waste-form')[0].reset();
            // 刷新圖表
            fetchWeeklyWasteData().then(updateChart);
        });
    });

    // 初始化頁面
    $(document).ready(function() {
        // 設置日期選擇器默認為今天
        $('#process-date').val(new Date().toISOString().split('T')[0]);
        
        // 獲取並顯示本週數據
        fetchWeeklyWasteData().then(updateChart);
    });
</script>
{{/inline}}

{{/layouts/main}} 